<!DOCTYPE html>
<html lang="en_us">
<head>
        <meta charset="utf-8" />
        <title>Interlines - MKL</title>
        <link rel="stylesheet" href="http://alexsavio.github.io/theme/css/main.css" />
        <link href="http://alexsavio.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Interlines Atom Feed" />
        <link href="http://alexsavio.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Interlines RSS Feed" />


        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="http://github.com/alexsavio">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://alexsavio.github.io/">Interlines  <strong>Lost in spikes</strong></a></h1>
                <nav><ul>
                    <li><a href="about.html">About</a></li>
                    <li><a href="http://www.ehu.es/ccwintco/index.php/Usuario:Alexsavio">My CV</a></li>
                    <li><a href="http://alexsavio.github.io/category/latex.html">LaTex</a></li>
                    <li><a href="http://alexsavio.github.io/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://alexsavio.github.io/numpy_scipy_mkl.html">Compile Numpy and Scipy against Intel <span class="caps">MKL</span></a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-04-08T22:00:00">
                Published: Tue 08 April 2014
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://alexsavio.github.io/author/alexandre-savio.html">Alexandre Savio</a>
        </address>
<p>In <a href="http://alexsavio.github.io/category/python.html">Python</a>. </p>
<p>tags: <a href="http://alexsavio.github.io/tag/numpy.html">Numpy</a><a href="http://alexsavio.github.io/tag/scipy.html">Scipy</a><a href="http://alexsavio.github.io/tag/mkl.html">MKL</a></p>
</footer><!-- /.post-info --><h6>Tested on Ubuntu 13.10 and&nbsp;14.04</h6>
<h3>1. Install C++ Composer and <span class="caps">FORTRAN</span> Composer, with <span class="caps">MKL</span></h3>
<p>Fill forms and download online installation shell scripts from <a href="http://software.intel.com/en-us/non-commercial-software-development">here</a>.</p>
<h3>2. Execute shell scripts with&nbsp;sudo</h3>
<p>I will assume the libraries will be installed in&nbsp;/opt/intel.</p>
<h3>3. Once installed, add this to&nbsp;~/.bashrc</h3>
<div class="codehilite"><pre>#Intel C++ Studio
if [ -d /opt/intel ]; 
then
    export INTEL_HOME=/opt/intel
    export PATH=<span class="cp">${</span><span class="n">PATH</span><span class="cp">}</span>:<span class="cp">${</span><span class="n">INTEL_HOME</span><span class="cp">}</span>/bin
    export LD_LIBRARY_PATH=/opt/intel/mkl/lib/intel64:/opt/intel/lib/intel64:<span class="cp">${</span><span class="n">LD_LIBRARY_PATH</span><span class="cp">}</span>
fi
</pre></div>


<h3>4. Add this to&nbsp;/etc/ld.so.conf.d/intel.conf:</h3>
<div class="codehilite"><pre><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">intel64</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">intel64</span><span class="o">/</span><span class="n">irml</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">intel64</span><span class="o">/</span><span class="n">crt</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">mkl</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">intel64</span>
</pre></div>


<h3>5. Download Numpy and Scipy from [here]&nbsp;(http://www.scipy.org/scipylib/download.html)</h3>
<h3>6. Modify Numpy source&nbsp;code:</h3>
<ul>
<li>
<p>Change directory to&nbsp;numpy-x.x.x</p>
</li>
<li>
<p>Create a site.cfg from the existing&nbsp;site.cfg.examle</p>
</li>
<li>
<p>Edit site.cfg as&nbsp;follows:</p>
</li>
</ul>
<p>Add the following lines to site.cfg in your top level NumPy directory to use IntelÂ® <span class="caps">MKL</span>, if you are building on Intel 64 platform, assuming the default path for the Intel <span class="caps">MKL</span> installation from the Intel Parallel Studio <span class="caps">XE</span> 2013 or Intel Composer <span class="caps">XE</span> 2013&nbsp;versions:</p>
<div class="codehilite"><pre><span class="k">[mkl]</span>
<span class="na">library_dirs</span> <span class="o">=</span> <span class="s">/opt/intel/mkl/lib/intel64</span>
<span class="na">include_dirs</span> <span class="o">=</span> <span class="s">/opt/intel/mkl/include</span>
<span class="na">mkl_libs</span> <span class="o">=</span> <span class="s">mkl_rt</span>
<span class="na">lapack_libs</span> <span class="o">=</span>
</pre></div>


<p>If you are building NumPy for 32 bit, please add as the&nbsp;following:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">mkl</span><span class="p">]</span> 
<span class="n">library_dirs</span> <span class="o">=</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">mkl</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ia32</span>
<span class="n">include_dirs</span> <span class="o">=</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">mkl</span><span class="o">/</span><span class="n">include</span>
<span class="n">mkl_libs</span> <span class="o">=</span> <span class="n">mkl_rt</span>
<span class="n">lapack_libs</span> <span class="o">=</span>
</pre></div>


<ul>
<li>
<p>Modify cc_exe in numpy/distutils/intelccompiler.py to be something&nbsp;like:</p>
<p>self.cc_exe = &#8216;icc -O3 -g -fPIC -fp-model strict -fomit-frame-pointer -openmp&nbsp;-xhost&#8217; </p>
</li>
<li>
<p>Here we use, -O3, optimizations for speed and enables more aggressive loop transformations such as Fusion, Block-Unroll-and-Jam, and collapsing <span class="caps">IF</span> statements, -openmp for OpenMP threading and -xhost option tells the compiler to generate instructions for the highest instruction set available on the compilation host processor. If you are using the <span class="caps">ILP64</span> interface, please add -DMKL_ILP64 compiler&nbsp;flag.</p>
</li>
<li>
<p>Run icc &#8212;help for more information on processor-specific options, and refer Intel Compiler documentation for more details on the various compiler&nbsp;flags.</p>
</li>
<li>
<p>Modify the the Fortran compiler flags in numpy-x.x.x/numpy/distutil/fcompiler/intel.py to use the following compiler options for the Intel Fortran&nbsp;Compiler:</p>
</li>
<li>
<p>For ia32 and&nbsp;Intel64</p>
<p>ifort -xhost -openmp -fp-model strict&nbsp;-fPIC</p>
</li>
<li>
<p>Modify the get_flags_opt function line&nbsp;to:</p>
<p>return [&#8216;-xhost -openmp -fp-model&nbsp;strict&#8217;]</p>
</li>
</ul>
<p>If you are using <span class="caps">ILP64</span> interface of Intel <span class="caps">MKL</span>, please add -i8 flag above.  If you are using older versions of Numpy/SciPy, please refer the new intel.py for your reference from the latest version of NumPy, which can be replaced to use the above mentioned compiler&nbsp;options.</p>
<h3>7. Compile Numpy and Scipy with the following command (once for Numpy and then once for&nbsp;Scipy):</h3>
<p>Remember to activate the virtual environment if you are going to use this in&nbsp;one.</p>
<h4>7.1 For&nbsp;64-bit:</h4>
<div class="codehilite"><pre><span class="n">cd</span> <span class="o">&lt;</span><span class="n">numpy</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">config</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_clib</span> \
<span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_ext</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">install</span>

<span class="n">cd</span> <span class="o">&lt;</span><span class="n">scipy</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">config</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_clib</span> \
<span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_ext</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">install</span>
</pre></div>


<h4>7.2 For&nbsp;32-bit:</h4>
<div class="codehilite"><pre><span class="n">cd</span> <span class="o">&lt;</span><span class="n">numpy</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">config</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intel</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intel</span> <span class="n">build_clib</span> \
<span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intel</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intel</span> <span class="n">build_ext</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intel</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intel</span> <span class="n">install</span>

<span class="n">cd</span> <span class="o">&lt;</span><span class="n">scipy</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">config</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_clib</span> \
<span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">build_ext</span> <span class="o">--</span><span class="n">compiler</span><span class="o">=</span><span class="n">intelem</span> <span class="o">--</span><span class="n">fcompiler</span><span class="o">=</span><span class="n">intelem</span> <span class="n">install</span>
</pre></div>


<h3>8.&nbsp;Troubleshooting:</h3>
<h4>8.1 Compiling Scipy: &#8220;Using deprecated NumPy <span class="caps">API</span>, disable it&nbsp;by&#8230;&#8221;</h4>
<ul>
<li>
<p>Maybe it is the version of <span class="caps">GCC</span>, try using 4.7 (worked in November&nbsp;2013):</p>
<p>sudo apt-get install gcc-4.7
sudo rm /usr/bin/gcc
sudo ln -s /usr/bin/gcc-4.7&nbsp;/usr/bin/gcc</p>
</li>
</ul>
<p>Compile both Numpy and Scipy&nbsp;again.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://bcig.eu/">BCIG.EU</a></li>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://alexsavio.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            <li><a href="http://alexsavio.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                            <li><a href="http://twitter.com/alex_savio">twitter</a></li>
                            <li><a href="http://github.com/alexsavio">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>